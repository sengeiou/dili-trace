<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dili.trace.dao.TradeRequestMapper">

  <select id="queryListByOrderStatus" parameterType="com.dili.trace.api.input.TradeRequestInputDto" resultType="com.dili.trace.domain.TradeRequest">
    <![CDATA[
      SELECT r.id,r.buyer_id,r.buyer_name,r.code,r.created,r.modified,
      r.product_name,r.product_stock_id,r.reason,r.return_status,r.seller_id,r.seller_name,r.spec_name,
      r.trade_order_Id,r.trade_weight,r.weight_unit
      FROM trade_request r,trade_order o WHERE o.id = r.trade_order_Id
      AND (r.buyer_id = #{buyerId} OR r.seller_id = #{buyerId})
      and (r.created >= #{createdStart} and r.created <=#{createdEnd})
      and o.order_status = #{orderStatus}
     ]]>
  </select>

  <select id="selectBuyerIdWithouTradeRequest" parameterType="com.dili.trace.dto.UserListDto" resultType="java.lang.Long">
    select id from `user` where id not in(
    select t.buyer_id from trade_request t, trade_order o where t.return_status != 20 and o.order_status=10
    <if test="createdStart != null">
      <![CDATA[ AND #{createdStart}<=t.created ]]>
    </if>
    <if test="createdEnd != null">
      <![CDATA[AND t.created <=#{createdEnd}]]>
    </if>
    )
    <![CDATA[ AND `user`.qr_status <>#{qrStatus}]]>
  </select>

  <select id="selectScanOrderReport" parameterType="com.dili.trace.dto.PushDataQueryDto" resultType="com.dili.trace.dto.thirdparty.report.ReportScanCodeOrderDto">
    SELECT r.`created` orderTime, r.`buyer_id` thirdBuyId, r.`id` thirdOrderId, r.`seller_id` thirdSellId
      FROM trade_request r
      JOIN trade_order o ON (r.trade_order_Id = o.id AND o.order_status = 10)
      JOIN `user` u ON (r.`buyer_id` = u.`id` AND u.`source` = 20)
      WHERE r.return_status = 0
      <if test="modifiedEnd != null">
        <![CDATA[AND o.modified <=#{modifiedEnd}]]>
      </if>
      <if test="modifiedStart != null">
        <![CDATA[AND o.modified >#{modifiedStart}]]>
      </if>
  </select>

  <select id="selectDeliveryOrderReport" parameterType="com.dili.trace.dto.PushDataQueryDto" resultType="com.dili.trace.dto.thirdparty.report.ReportDeliveryOrderDto">
    SELECT r.`created` orderTime, r.`buyer_id` thirdDsId, r.`id` thirdOrderId, r.`seller_id` thirdAccId
      FROM trade_request r
      JOIN trade_order o ON (r.trade_order_Id = o.id AND o.order_status = 10)
      JOIN `user` u ON (r.`buyer_id` = u.`id` AND u.`source` = 10)
      WHERE r.return_status = 0
      <if test="modifiedEnd != null">
        <![CDATA[AND o.modified <=#{modifiedEnd}]]>
      </if>
      <if test="modifiedStart != null">
        <![CDATA[AND o.modified >#{modifiedStart}]]>
      </if>
  </select>

  <select id="selectOrderDetailReport" parameterType="com.dili.trace.dto.PushDataQueryDto" resultType="com.dili.trace.dto.thirdparty.report.ReportOrderDetailDto">
    SELECT d.`trade_request_id` requestId,d.`id` detailId, d.`total_weight` orderNum, d.`bill_id` thirdEnterId, p.`trade_request_id` thirdOrderParentId,
      d.`parent_id` thirdOrderDetailParentId, IF(d.`weight_unit`=1,'斤','公斤') unitName
    FROM `trade_detail` d
      LEFT JOIN `trade_detail` p ON d.`parent_id` = p.`id`
    WHERE d.`trade_request_id` in
      <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
        #{id}
      </foreach>
  </select>

  <select id="selectDeletedScanOrderReport" parameterType="com.dili.trace.dto.PushDataQueryDto" resultType="com.dili.trace.dto.thirdparty.report.ReportDeletedOrderDto">
    SELECT GROUP_CONCAT(r.id) thirdOrderIds
    FROM trade_request r
    JOIN `user` u ON (r.`buyer_id` = u.`id` AND u.`source` = 20)
    WHERE r.return_status = 20
    <if test="modifiedEnd != null">
      <![CDATA[AND r.modified <=#{modifiedEnd}]]>
    </if>
    <if test="modifiedStart != null">
      <![CDATA[AND r.modified >#{modifiedStart}]]>
    </if>
  </select>

  <select id="selectDeletedDeliveryOrderReport" parameterType="com.dili.trace.dto.PushDataQueryDto" resultType="com.dili.trace.dto.thirdparty.report.ReportDeletedOrderDto">
    SELECT GROUP_CONCAT(r.id) thirdOrderIds
    FROM trade_request r
    JOIN `user` u ON (r.`buyer_id` = u.`id` AND u.`source` = 10)
    WHERE r.return_status = 20
    <if test="modifiedEnd != null">
      <![CDATA[AND r.modified <=#{modifiedEnd}]]>
    </if>
    <if test="modifiedStart != null">
      <![CDATA[AND r.modified >#{modifiedStart}]]>
    </if>
  </select>

  <select id="queryPurchaseGoodsReportList" parameterType="com.dili.trace.dto.PurchaseGoodsReportQueryDto"
          resultType="com.dili.trace.dto.PurchaseGoodsReportDto">
    SELECT t.`product_name` as product_name,
    round(SUM(IF(d.weight_unit=1,d.stock_weight*0.0005,d.stock_weight*0.001)),2) as weight
    FROM `trade_request` t, trade_order o, `trade_detail` d, product_stock p
    WHERE o.`order_status`=10
    <if test="startDate != null">
      <![CDATA[AND t.`handle_time`>=#{startDate}]]>
    </if>
    <if test="endDate != null">
      <![CDATA[AND t.`handle_time`<=#{endDate}]]>
    </if>
    <if test="productName != null and productName != ''">
    and t.product_name like #{productName}
    </if>
    AND t.`return_status`!=20
    AND t.trade_order_id = o.id AND t.id = d.`trade_request_id`
    AND d.`product_stock_id`=p.`id`
    GROUP BY t.`product_name` order by weight desc

  </select>

  <select id="queryUserPurchaseReportList" parameterType="com.dili.trace.dto.UserPurchaseReportQueryDto"
          resultType="com.dili.trace.dto.PurchaseGoodsReportDto">
    SELECT user.name as user_name, t.`product_name` as product_name,
    round(SUM(IF(d.weight_unit=1,d.stock_weight*0.0005,d.stock_weight*0.001)),2) as weight
    FROM `trade_request` t, trade_order o, `trade_detail` d, product_stock p, user user
    WHERE o.`order_status`=10
    <if test="startDate != null">
      <![CDATA[AND t.`handle_time`>=#{startDate}]]>
    </if>
    <if test="endDate != null">
      <![CDATA[AND t.`handle_time`<=#{endDate}]]>
    </if>
    <if test="userName != null and userName != ''">
      and user.name like #{userName}
    </if>
    <if test="phone != null and phone != ''">
      and user.phone like #{phone}
    </if>
    AND t.`return_status`!=20
    AND t.trade_order_id = o.id AND t.id = d.`trade_request_id`
    AND d.`product_stock_id`=p.`id`
    and user.id = t.buyer_id
    GROUP BY user.name, t.`product_name` order by user.name, weight desc

  </select>





</mapper>