<#bs4Body>
<div class="container-fluid">
    <form id="queryForm" role="form" >
        <div class="row row-cols-6">

            <div class="form-group col">
                <label for="state">状态</label>
                <select id="state" name="state" class="form-control"></select>
                <#bcomboProvider _id="state" _provider="registerBillStateProvider" _value="" _onLoadSuccess=""/>
            </div>
            <!--likeProductName-->
            <div class="form-group col">
                <label for="productName">商品</label>
                <input id="productName" name="productName" class="form-control" />
                <!--<select id="productId" name="productId" class="form-control"></select>-->
            </div>
            <!--_salesCityName-->
            <div class="form-group col">
                <label for="originName">产地</label>
                <input id="originName" name="originName" class="form-control" />
            </div>
            <div class="form-group col">
                <label for="detectState">检测结果</label>
                <select id="detectState" name="detectState" class="form-control"></select>
                <#bcomboProvider _id="detectState" _provider="billDetectStateProvider" _value="" _onLoadSuccess=""/>
            </div>

            <div class="form-group col">
                <label for="hasCheckSheet">检测报告</label>
                <select id="hasCheckSheet" name="hasDetectReport" class="form-control">
                    <option value="">--请选择--</option>
                    <option value="hasCheckSheet=false">未打印</option>
                    <option value="hasCheckSheet=true">已打印</option>
                </select>
                <input  type="hidden"  name="hasCheckSheet">
                <input  type="hidden"  name="hasDetectReport">
            </div>

            <div class="form-group col-auto">
                <label for="latestDetectTimeTimeStart">检测时间</label>
                <div class="form-inline">
                    <div class="input-group">
                        <input type="text" name="latestDetectTimeTimeStart" id="latestDetectTimeTimeStart"
                               autocomplete="off"
                               class="form-control settletime laystart" />

                        <div class="input-group-append">
                            <label for="latestDetectTimeTimeStart" class="input-group-text fa fa-calendar"></label>
                        </div>
                    </div>&nbsp;&nbsp;至&nbsp;&nbsp;
                    <div class="input-group">
                        <input type="text" name="latestDetectTimeTimeEnd"  autocomplete="off" id="latestDetectTimeTimeEnd" class="form-control laydatetime layend"/>
                        <div class="input-group-append">
                            <label for="latestDetectTimeTimeEnd" class="input-group-text fa fa-calendar"></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group col-auto">
                <label for="createdStart">登记时间</label>
                <div class="form-inline">
                    <div class="input-group">
                        <input type="text" name="createdStart"  autocomplete="off" id="createdStart" class="form-control laydatetime laystart"/>
                        <div class="input-group-append">
                            <label for="createdStart" class="input-group-text fa fa-calendar"></label>
                        </div>
                    </div>&nbsp;&nbsp;至&nbsp;&nbsp;
                    <div class="input-group">
                        <input type="text" name="createdEnd"  autocomplete="off" id="createdEnd" class="form-control laydatetime layend"/>
                        <div class="input-group-append">
                            <label for="createdEnd" class="input-group-text fa fa-calendar"></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group col">
                <label for="likeName">业户姓名</label>
                <input type="text" class="form-control" name="likeName" id="likeName"/>
            </div>

            <div class="form-group col">
                <label for="likeCorporateName">企业名称</label>
                <input type="text" class="form-control" name="likeCorporateName" id="likeCorporateName"/>
            </div>

            <div class="form-group col">
                <label for="code">登记编号</label>
                <input type="text" class="form-control" name="code" id="code"/>
            </div>

            <div class="col-auto align-self-center mt-3">
                <button id="clear" type="button" class="btn btn-outline-primary mr-2" onclick="javascript:$('#queryForm .form-control').val('');"><i class="fa fa-refresh"></i> 清空</button>
                <button id="query" type="button" class="btn btn-outline-primary"><i class="fa fa-search"></i> 查询</button>
            </div>
        </div>
    </form>
    <hr>
    <div>
        <div id="toolbar" class="btn-group" role="group" aria-label="工具栏">
            <button id="add-btn" type="button" class="btn btn-primary"><i class="fa fa-plus"></i> 新增</button>
            <button id="audit-btn" style="display: none" type="button" class="btn btn-primary"><i class="fa  fa-user"></i> 进场审核</button>
            <button id="batch-reviewCheck-btn" style="display: none" type="button" class="btn btn-primary"><i class="fa  fa-check-square-o"></i> 批量复检</button>
            <button id="createsheet-btn" style="display: none" type="button" class="btn btn-primary"><i class="fa  fa-plus"></i> 创建打印报告</button>
            <button id="detail-btn" style="display: none" type="button" class="btn btn-primary"><i class="fa  fa-list"></i> 查看</button>
            <button id="export" style="display: none" type="button" class="btn btn-primary" onclick="bui.util.doExport('commissionBillGrid','queryForm')"><i class="fa fa-download"></i> 导出</button>
        </div>
        <table id="commissionBillGrid" data-toggle="table" data-title="委托登记单列表" class="table" data-toolbar="#toolbar" data-pagination="true" data-page-number="1" data-page-size="10"
               data-query-params="queryParams" data-side-pagination="server" data-method="POST" data-content-type="application/json" data-single-select="false"
               data-click-to-select="true"  data-checkbox-header="true" data-unique-id="id" data-sort-name="id" data-sort-order="desc"  data-icons="bui.variable.icons" data-buttons-class="primary"
               data-show-refresh="true" data-show-fullscreen="true" data-show-columns="true" data-detail-view="false">
            <thead>
            <tr>
                <th data-checkbox="true"></th>
                <th data-field="created" data-sortable="true" data-align="center" data-provider="datetimeProvider">
                    登记时间
                </th>
                <th data-field="code" data-sortable="true" data-align="center">
                    编号
                </th>
                <th data-field="sampleCode" data-sortable="true" data-align="center">
                    采样编号
                </th>
                <th data-field="name" data-sortable="true" data-align="center">
                    业户姓名
                </th>
                <th data-field="corporateName" data-sortable="true" data-align="center">
                    企业姓名
                </th>
                <th data-field="productName" data-sortable="true" data-align="center">
                    商品名称
                </th>
                <th data-field="weight" data-sortable="true" data-align="center">
                    重量
                </th>
                <th data-field="weightUnitName" data-sortable="true" data-align="center">
                    重量单位
                </th>

                <th data-field="originName" data-sortable="true" data-align="center">
                    产地
                </th>
                <th data-field="checkSheetId" data-sortable="true" data-align="center" data-provider="hasOrNoneProvider">
                    打印报告
                </th>
                <th data-field="detectStatusName" data-sortable="true" data-align="center">
                    检测状态
                </th>
                <th data-field="detectRequest.detectResultName" data-sortable="true" data-align="center">
                    检测结果
                </th>
                <th data-field="latestPdResult" data-sortable="true" data-align="center">
                    检测值
                </th>
                <th data-field="latestDetectTime" data-sortable="true" data-align="center" data-provider="datetimeProvider">
                    检测时间
                </th>
                <th data-field="latestDetectOperator" data-sortable="true" data-align="center">
                    检测员
                </th>
            </tr>
            </thead>
        </table>
    </div>
</div>
</#bs4Body>

<script src="${contextPath!}/resources/assets/dep/underscore/underscore-min.js"></script>
<script src="${contextPath!}/resources/js/jquery.serializejson.js"></script>
<script src="${contextPath!}/resources/js/jqueryWrapper.js"></script>
<script src="${contextPath!}/resources/js/WebConfig.js"></script>
<script src="${contextPath!}/resources/js/commissionbill.index.js"></script>
<script src="${contextPath!}/resources/assets/dep/jquery/laydate/laydate.js"></script>
<#webGlobalConfig/>

<script>
    laydate.render({
        elem: '#latestDetectTimeTimeStart',
        type: 'datetime'
    });
    laydate.render({
        elem: '#latestDetectTimeTimeEnd',
        type: 'datetime'
    });
    laydate.render({
        elem: '#createdStart',
        type: 'datetime'
    });
    laydate.render({
        elem: '#createdEnd',
        type: 'datetime'
    });
    $(function () {
        var commissionBillGrid=new CommissionBillGrid($('#commissionBillGrid'),$('#queryForm'),$('#toolbar'));
    });

    window._commissionBillGrid = $('#commissionBillGrid');
    function onBeforeLoad(param) {
        return true;
    }
    var highLightBill={};
    function findHighLightBill(){
        highLightBill = {};
        $.ajax({
            type: "POST",
            url: "${contextPath}/commissionBill/findHighLightBill.action",
            processData:true,
            dataType: "json",
            data:{},
            async : false,
            success: function (ret) {
                if(ret&&ret.code=='200'){
                    highLightBill = ret.data;
                }
            },
            error: function(){
                highLightBill = {}
            }
        });
    }
    function coloredRowRender(index,row){
        if(highLightBill&&highLightBill.id&&row.id==highLightBill.id){
            return {style:'background:#7dc57d'};
        }
    }

    function onPlateChange(v){
        if(v&&v!='全部'){
            queryCommissionBillGrid();
        }

    }

    //表格表头右键菜单
    function headerContextMenu(e, field){
        e.preventDefault();
        if (!cmenu){
            createColumnMenu("commissionBillGrid");
        }
        cmenu.menu('show', {
            left:e.pageX,
            top:e.pageY
        });
    }


    async function audit(){
        var selected = _commissionBillGrid.datagrid("getSelected");
        if (null == selected) {
            swal({
                title: '警告',
                text: '请选中一条数据',
                type: 'warning',
                width: 300
            });
            return;
        }
        var url='${contextPath}/commissionBill/audit.html?billId=' + selected.id;

        layer.open({
            type: 2,
            title: "审核",
            shadeClose: true,
            shade: 0.3,
            offset: "20%",
            shadeClose : false,
            area: ['800px', "350px"],
            content: url,//传入一个链接地址 比如：http://www.baidu.com
            btn: ['进场审核','取消'],
            yes: function(index, layero){
                $.ajax({
                    type: "POST",
                    data:{billId:selected.id},
                    url: "${contextPath}/commissionBill/doAuditCommissionBillByManager.action",
                    processData:true,
                    dataType: "json",

                    async : true,
                    success: function (ret) {
                        if(ret.success){
                            _commissionBillGrid.datagrid("reload");
                            TLOG.component.operateLog('登记单管理',"审核","【编号】:"+selected.code);
                            // layer.alert('操作成功',{title:'操作',time : 3000});

                            layer.alert('操作成功',{
                                    title:'操作',
                                    time : 600,
                                    end :function(){
                                        layer.closeAll();

                                    }
                                },
                                function () {
                                    layer.closeAll();
                                }
                            );

                        }else{
                            swal(
                                '操作',
                                ret.result,
                                'info'
                            );
                            layer.closeAll();

                        }

                    },
                    error: function(){

                        swal(
                            '错误',
                            '远程访问失败',
                            'error'
                        );
                        layer.closeAll();
                    }
                });
            }
        });



        let promise = new Promise((resolve, reject) => {
            layer.open(codeList.join("<br\>"), {btn: ['确定', '取消'], title: "批量审核"},function () {
                    resolve("yes");
                },function(){
                    resolve("cancel");
                }
            );
        });

        let result = await promise; // wait until the promise resolves (*)




    }
    function blankFormatter(val,row){
        if(!val){
            return "-";
        }
        return val;
    }

    function closeLastWin(id){
        $('#' + id).last().remove();
    }
    function closeWin(id){
        $('#' + id).remove();
        $('#commissionBillGrid').datagrid('reload');
    }
    function openWin(url){
        $('body').append('<iframe id="view_win" name="view_win" src="' + url + '" style="border:0px;width:100%;height:100%;position:fixed;left:0;top:0"></iframe>');
    }
    function openInsert(){
        openWin('${contextPath}/commissionBill/create.html');
    }


    //打开处理结果窗口
    function openIframe(content,selected){}
    function doDetail(){
        var selected = _commissionBillGrid.datagrid("getSelected");
        if (null == selected) {
            swal({
                title: '警告',
                text: '请选中一条数据',
                type: 'warning',
                width: 300
            });
            return;
        }
        openWin('${contextPath}/commissionBill/view/' + selected.id+'/true');
    }
    function cityLoader(param,success,error) {
        var q = param.q || '';
        if (q.length < 1){return false}
        $.ajax({
            type: "POST",
            url: '${contextPath}/provider/getLookupList.action',
            dataType: 'json',
            data: {
                provider: 'cityProvider',
                queryParams: '{required:true}',
                value: q
            },
            success: function(data){
                success(data);
            },
            error: function(){
                error.apply(this, arguments);
            }
        });
    }
    function doCreateCheckSheet(){
        var selected = _commissionBillGrid.datagrid("getSelected");
        if (null == selected) {
            swal({
                title: '警告',
                text: '请选中一条数据',
                type: 'warning',
                width: 300
            });
            return;
        }

        var rows=_commissionBillGrid.datagrid("getSelections");
        var idList=rows.filter(function(v,i){return true;}).map(function(v,i){return v.id});
        openWin('/checkSheet/edit.html?' +$.param({idList:idList},true));
    }
    function openLayer(url){
        layer.open({
            area: ['600px', "400px"],
            title: '审核',
            content: [url, 'no'], //iframe的url
            btn: ['确定', '取消'],
            yes: function (index, layero) {
                //按钮【确认】的回调
                var body = layer.getChildFrame('body', index); //iframe的body获取方式
                var password = $(body).find("#password").val();
            }
        });
    }




    $('.fileimg-view').on('click', function () {
        var url = $(this).parent().siblings(".magnifying").attr('src');
        if(url){
            layer.open({
                title: '图片',
                type: 1,
                skin: 'layui-layer-rim',
                closeBtn: 2,
                area: ['90%', '90%'], //宽高
                content: '<p style="text-align:center"><img src="' + url + '" alt="" class="show-image-zoom"></p>'
            });
        }
    });
    $('.fileimg-delete').on('click', function () {

        var imgBox=$(this).parents('.fileimg-box:first');
        var td= imgBox.parent('td');
        var imgBoxArr=td.find('.fileimg-box');
        if(imgBoxArr.length==10){
            var lastImgBox=$(imgBoxArr[imgBoxArr.length-1]);
            if(lastImgBox.find("input:hidden").val()!=''){

                imgBox.find(".magnifying").attr('src', '').hide();
                imgBox.find("input:hidden").val('');
                imgBox.find('.fileimg-cover,.fileimg-edit').hide();

                imgBox.appendTo(td);
            }else{
                imgBox.remove();
            }
        }else if(imgBoxArr.length>1){
            imgBox.remove();
        }else{
            imgBox.find(".magnifying").attr('src', '').hide();
            imgBox.find("input:hidden").val('');
            imgBox.find('.fileimg-cover,.fileimg-edit').hide();
        }

    });
    function initFileUpload(){
        initFileInput($("input[type='file']"));
    }
    function afterUpload(url,fileInputObj){
        var imgBox=fileInputObj.parent();
        var td= imgBox.parent('td');
        var newImgBox=imgBox.clone(true);

        imgBox.find(".magnifying").attr('src', url).show();
        imgBox.find("input[type='hidden']").val(url);
        imgBox.find('.fileimg-cover,.fileimg-edit').show();
        //console.info(url)
        //debugger
        if(td.find('.fileimg-box').length<10){
            newImgBox.find('input[type="file"]').remove();
            $('<input type="file" name="file" data-url="${contextPath!}/action/imageApi/upload" multiple="multipart/form-data" />').insertAfter(newImgBox.find('.fileimg-des'))
            newImgBox.appendTo(td);
            initFileInput(newImgBox.find('input[type="file"]'))
        }
    }

    function initFileInput(jqueryObj){
        jqueryObj.fileupload({
            dataType: 'json',
            formData: { type: 5, compress: true },
            done: function (e, res) {
                if (res.result.code == 200) {
                    var url = res.result.data;
                    var fileInputObj = $(e.target);
                    afterUpload(url, fileInputObj);
                    /*var imgBox=fileInputObj.parent();
                    var td= imgBox.parent('td');
                     var newImgBox=imgBox.clone(true);

                    imgBox.find(".magnifying").attr('src', url).show();
                    imgBox.find("input:hidden").val(url);
                    imgBox.find('.fileimg-cover,.fileimg-edit').show();

                    if(td.find('.fileimg-box').length<10){
                        newImgBox.find('input[type="file"]').remove();
                        $('<input type="file" name="file"  data-url="${contextPath!}/action/imageApi/upload" multiple="multipart/form-data" />').insertAfter(newImgBox.find('.fileimg-des'))
                        newImgBox.appendTo(td);
                        initFileInput(newImgBox.find('input[type="file"]'))
                    }*/
                }
            },
            add: function (e, data) {//判断文件类型 var acceptFileTypes = /\/(pdf|xml)$/i;
                var acceptFileTypes = /^gif|bmp|jpe?g|png$/i;
                var name = data.originalFiles[0]["name"];
                var index = name.lastIndexOf(".") + 1;
                var fileType = name.substring(index, name.length);
                if (!acceptFileTypes.test(fileType)) {
                    swal('错误', '请您上传图片类文件jpe/jpg/png/bmp!', 'error');
                    return;
                }
                var size = data.originalFiles[0]["size"];
                // 10M
                if (size > (1024 * 10 * 1024)) {
                    swal('错误', '上传文件超过最大限制!', 'error');
                    return;
                }
                data.submit();
            }
        });


    }


</script>

<!--
 <script src="http://base.nong12.com/static/log/log.build.js"></script>
 <link rel="stylesheet" type="text/css" href="${contextPath!}/resources/jquery-file-upload/css/jquery.fileupload.css">
 <script src="${contextPath!}/resources/jquery-file-upload/js/vendor/jquery.ui.widget.js"></script>
 <script src="${contextPath!}/resources/jquery-file-upload/js/jquery.iframe-transport.js"></script>
 <script src="${contextPath!}/resources/jquery-file-upload/js/jquery.fileupload.js"></script>
 <script src="/resources/assets/dep/jquery/layer/layer.js"></script>
<script src="${contextPath!}/resources/assets/dep/underscore/underscore-min.js"></script>
<script src="${contextPath!}/resources/js/commissionbill.index.js"></script>

 <script>
 function multipleSelectOnChange(n,o){

    $('input[name="hasDetectReport"]').val('')
      $('input[name="hasCheckSheet"]').val('')

    if(n=='hasDetectReport=true'){
         $('input[name="hasDetectReport"]').val('true')
     }else if(n=='hasDetectReport=false'){
         $('input[name="hasDetectReport"]').val('false')
     }else if(n=='hasCheckSheet=true'){
         $('input[name="hasCheckSheet"]').val('true')
     }else if(n=='hasCheckSheet=false'){
         $('input[name="hasCheckSheet"]').val('false')
     }else{
         $('input[name="hasDetectReport"]').val('')
         $('input[name="hasCheckSheet"]').val('')
     }
 }
 </script>-->
