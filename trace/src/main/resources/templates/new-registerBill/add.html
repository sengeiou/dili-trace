<#bs4Body>
<#vueElm />
<div id="app">
    <ele-form
            v-bind="formConfig"
            v-model="formData"
            :request-fn="handleRequest"
    >
        <template v-slot:weight="{ desc, data, field, formData }">
            <el-input placeholder="请输入内容" v-model="formData.weight" class="input-with-select">
                <el-select v-model="formData.weightUnit" slot="append">
                    <el-option label="斤" value="1"></el-option>
                    <el-option label="公斤" value="2"></el-option>
                </el-select>
            </el-input>
        </template>
        <template v-slot:pieceweight="{ desc, data, field, formData }">
            <el-input placeholder="请输入内容" v-model="formData.pieceweight" class="input-with-select"
                      @input="changePieceWeight">
                <el-select v-model="formData.pieceweightUnit" slot="append">
                    <el-option label="斤" value="1"></el-option>
                    <el-option label="公斤" value="2"></el-option>
                </el-select>
            </el-input>
        </template>
    </ele-form>
</div>
<script src="${contextPath}/resources/design/extends/vue-ele-form-image-uploader/dist/vue-ele-form-image-uploader.umd.min.js"></script>
<style>
    .el-input-group__append .el-select .el-input {
        width: 130px;
    }

    .input-with-select .el-input-group__prepend {
        background-color: #fff;
    }
</style>
<script type="text/javascript">
    // 表单项配置
    let formDesc =
        {
            registType: {
                options: loadProvider({provider: 'registTypeProvider', queryParams: {required: true}}),
                type: "select",
                label: "单据类型"
            },
            userId: {
                type: "select",
                label: "卖家姓名",
                prop: {text: 'text', value: 'id'},
                attrs: {
                    filterable: true,
                    remote: true,
                    remoteMethod(query, callback) {
                        axios.post('/customer/listSeller.action', {'keyword': query})
                            .then((res) => {
                                const data = $.map(res.data.data, function (obj) {
                                    let cardNo = obj.tradePrintingCard;
                                    obj.text = obj.name + ' | ' + obj.phone + ' | ' + cardNo + ' | ' + obj.marketName
                                    return obj;
                                });
                                callback(data);
                            })
                            .catch(function (error) {
                                callback([]);
                            });
                    }
                }
            },
            arrivalTallynos: {
                type: "select",
                label: "到货摊位",
                optionsLinkageFields: ['userId', 'registerHeadCode'],
                prop: {text: 'text', value: 'text'},
                options: async data => {
                    let registerHeadCode = data.registerHeadCode;
                    if (registerHeadCode == undefined || registerHeadCode == '' || registerHeadCode == null) {
                        const list = await axios.post(
                            '/leaseOrderRpc/findLease.action',
                            {customerId: data.userId}
                        )
                        return $.map(list.data.data, function (obj) {
                            return {text: obj};
                        });
                    } else {
                        let registerHeadCodeTemp = app.registerHeadCodeTemp;
                        for (let i = 0; i < registerHeadCodeTemp.length; i++) {
                            let obj = registerHeadCodeTemp[i];
                            if (obj.code === registerHeadCode) {
                                return $.map(obj.arrivalTallynos, function (obj) {
                                    return {text: obj}
                                });
                            }
                        }
                    }

                },
                attrs: {
                    filterable: true,
                    multiple: true,
                    allowCreate: true
                }
            },
            registerHeadCode: {
                type: "select",
                label: "台账",
                optionsLinkageFields: ['userId'],
                prop: {text: 'text', value: 'code'},
                options: async data => {
                    const list = await axios.post(
                        '/registerHead/listRegisterHead.action',
                        {userId: data.userId, minRemainWeight: 0}
                    )
                    app.registerHeadCodeTemp = list.data.data;
                    return $.map(list.data.data, function (obj) {
                        obj.text = obj.productName + ' | ' + obj.weight + obj.weightUnitName + ' | ' + obj.created;
                        return obj;
                    });
                },
                vif: function (form) {
                    return form.registType === 30;

                },
                on: {
                    change: function (val) {
                        let registerHeadCodeTemp = app.registerHeadCodeTemp;
                        for (let i = 0; i < registerHeadCodeTemp.length; i++) {
                            let obj = registerHeadCodeTemp[i];
                            if (obj.code === val) {
                                app.formData.registerHeadWeight = obj.weight;
                                app.formData.registerHeadRemainWeight = obj.remainWeight;
                                app.formData.measureType = obj.measureType;
                                app.formData.truckType = obj.truckType;
                                app.formData.specName = obj.specName;
                                app.formData.brandName = obj.brandName;
                                app.formData.truckTareWeight = obj.truckTareWeight;
                                app.formData.arrivalDatetime = obj.arrivalDatetime;
                                app.formData.originId = obj.originId;
                                app.formData.productId = obj.productId;
                                app.formData.upStreamId = obj.upStreamId;
                            }
                        }
                    }
                }
            },
            registerHeadWeight: {
                isOptions: true,
                default: "0",
                type: "text",
                label: "主台账重量",
                vif: function (form) {
                    return form.registType === 30;

                }
            },
            registerHeadRemainWeight: {
                default: "0",
                type: "text",
                label: "待进门重量",
                vif: function (form) {
                    return form.registType === 30;

                }
            },
            truckType: {
                options: [
                    {
                        text: "是",
                        value: 20
                    },
                    {
                        text: "否",
                        value: 10
                    }
                ],
                type: "radio",
                label: "是否拼车"
            },
            plate: {
                type: "input",
                label: "车牌号",
                vif: function (form) {
                    return form.registType !== 30;

                },
            },
            plateList: {
                type: "select",
                label: "车牌号",
                prop: {text: 'text', value: 'text'},
                optionsLinkageFields: ['registerHeadCode'],
                options: data => {
                    let registerHeadCodeTemp = app.registerHeadCodeTemp;
                    for (let i = 0; i < registerHeadCodeTemp.length; i++) {
                        let obj = registerHeadCodeTemp[i];
                        if (obj.code === data.registerHeadCode) {
                            return $.map(obj.plateList, function (obj) {
                                return {text: obj};
                            });
                        }
                    }
                    return [];
                },
                vif: function (form) {
                    return form.registType === 30;
                },
            },
            productId: {
                type: "select",
                label: "商品品类",
                prop: {text: 'name', value: 'id'},
                optionsLinkageFields: ['registerHeadCode'],
                options: data => {
                    if (app !== undefined) {
                        let registerHeadCodeTemp = app.registerHeadCodeTemp;
                        for (let i = 0; i < registerHeadCodeTemp.length; i++) {
                            let obj = registerHeadCodeTemp[i];
                            if (obj.code === data.registerHeadCode) {
                                return [{name: obj.productName, id: obj.productId}]
                            }
                        }
                    }
                    return [];
                },
                attrs: {
                    filterable: true,
                    remote: true,
                    remoteMethod(query, callback) {
                        axios.post('/category/listCategories.action', {'keyword': query})
                            .then((res) => {
                                const data = $.map(res.data.data, function (obj) {
                                    return obj;
                                });
                                callback(data);
                            })
                            .catch(function (error) {
                                callback([]);
                            });
                    }
                }
            },
            measureType: {
                options: [
                    {
                        text: "计重",
                        value: 20
                    },
                    {
                        text: "计件",
                        value: 10
                    }
                ],
                type: "radio",
                label: "计重方式"
            },
            weight: {
                type: "input",
                label: "商品重量",
                rules: [{
                    pattern: new RegExp("^\\d+$", ""),
                    type: "string",
                    message: "格式不正确"
                }],
                vif: function (form) {
                    return form.measureType === 20;

                },
            },
            pieceNum: {
                type: "input",
                label: "商品件数",
                rules: [{
                    pattern: new RegExp("^\\d+$", ""),
                    type: "string",
                    message: "格式不正确"
                }],
                vif: function (form) {
                    return form.measureType !== 20;

                },
                on: {
                    input: function (value) {
                        if (!value || !app.formData.pieceweight) {
                            app.formData.total = 0;
                        } else {
                            app.formData.total = app.formData.pieceweight * value;
                        }

                    }
                }
            },
            pieceweight: {
                type: "input",
                label: "件重",
                rules: [{
                    pattern: new RegExp("^\\d+$", ""),
                    type: "string",
                    message: "格式不正确"
                }],
                vif: function (form) {
                    return form.measureType !== 20;

                }
            },
            total: {
                isOptions: true,
                default: "0",
                type: "text",
                label: "合计",
                attrs: {},
                vif: function (form) {
                    return form.measureType !== 20;

                },
            },
            specName: {
                type: "input",
                label: "商品规格",
                attrs: {}
            },
            brandName: {
                type: "autocomplete",
                label: "品牌",
                rules: [],
                attrs: {
                    valueKey: "brandName",
                    triggerOnFocus: false,
                    fetchSuggestions: function (queryString, cb) {
                        axios.post("/brand/listBrands.action", {likeBrandName: queryString})
                            .then(function (response) {
                                cb(response.data.data);
                            })
                            .catch(function (error) {
                            });
                    }
                }
            },
            originId: {
                type: "select",
                label: "产地",
                prop: {text: 'name', value: 'id'},
                optionsLinkageFields: ['registerHeadCode'],
                options: data => {
                    if (app != undefined) {
                        let registerHeadCodeTemp = app.registerHeadCodeTemp;
                        for (let i = 0; i < registerHeadCodeTemp.length; i++) {
                            let obj = registerHeadCodeTemp[i];
                            if (obj.code === data.registerHeadCode) {
                                return [{name: obj.originName, id: obj.originId}]
                            }
                        }
                    }
                    return [];
                },
                attrs: {
                    filterable: true,
                    remote: true,
                    // 相对于官方，增加了一个 callback 参数
                    remoteMethod(query, callback) {
                        axios.post('/city/listCities.action', {'keyword': query})
                            .then((res) => {
                                const data = $.map(res.data.data, function (obj) {
                                    return obj;
                                });
                                callback(data);
                            })
                            .catch(function (error) {
                                callback([]);
                            });
                    }
                }
            },
            upStreamId: {
                type: "select",
                label: "上游企业",
                prop: {text: 'name', value: 'id'},
                optionsLinkageFields: ['registerHeadCode'],
                options: data => {
                    if (app !== undefined) {
                        let registerHeadCodeTemp = app.registerHeadCodeTemp;
                        for (let i = 0; i < registerHeadCodeTemp.length; i++) {
                            let obj = registerHeadCodeTemp[i];
                            if (obj.code === data.registerHeadCode) {
                                return [{name: obj.upStreamName, id: obj.upStreamId}]
                            }
                        }
                    }
                    return [];
                },
                attrs: {
                    filterable: true,
                    remote: true,
                    // 相对于官方，增加了一个 callback 参数
                    remoteMethod(query, callback) {
                        axios.post('/upStream/listByKeyWord.action', {'keyword': query})
                            .then((res) => {
                                const data = $.map(res.data.data, function (obj) {
                                    return obj;
                                });
                                callback(data);
                            })
                            .catch(function (error) {
                                callback([]);
                            });
                    }
                }
            },
            truckTareWeight: {
                type: "input",
                label: "皮重"
            },
            arrivalDatetime: {
                type: "datetime",
                label: "到场时间"
            }
        };

    // 表单配置
    let formConfig = {
        formBtnSize: 'small',
        formAttrs: {size: 'small'},
        formDesc: formDesc,
        order: [
            "registType",
            "userId",
            "registerHeadCode",
            "registerHeadWeight",
            "registerHeadRemainWeight",
            "truckType",
            "plate",
            "plateList",
            "productId",
            "measureType",
            "weight",
            "pieceNum",
            "pieceweight",
            "total",
            "specName",
            "brandName",
            "originId",
            "upStreamId",
            "truckTareWeight",
            "arrivalDatetime",
            "arrivalTallynos"
        ]
    };

    var app = new Vue({
        el: '#app',
        created: function () {
            let imageCertTypeEnumMap = JSON.parse('${imageCertTypeEnumMap}');
            let prefix = "${imageViewPathPrefix}/";
            imageCertTypeEnumMap.forEach(it => {
                this.formConfig.formDesc["certType" + it.certType] = {
                    type: "image-uploader",
                    label: it.certTypeName,
                    attrs: {
                        name: "file",
                        multiple: true,
                        action: "/action/imageApi/upload",
                        responseFn(response, file) {
                            app.certTypeList.push({certType: it.certType, uid: response.data})
                            return prefix + response.data;
                        },
                        beforeRemove: function (file, fileList) {
                            app.certTypeList.splice(app.certTypeList.findIndex(item => item.uid === file.replace(prefix, "")), 1);
                        },
                        limit: "10"
                    }
                }
            })
        },
        data() {
            return {
                certTypeList: [],
                registerHeadCodeTemp: [],
                weightUnit: "",
                pieceweightUnit: "",
                formData: {
                    total: 0,
                    pieceNum: 0,
                    pieceweight: "",
                    measureType: 20,
                    registType: 10,
                    userId: "",
                    registerHeadCode: "",
                    arrivalTallynos: "",
                    plateList: [],
                    truckType: 20,
                    weightUnit: "1",
                    pieceweightUnit: "1",
                },
                formConfig:formConfig
            };
        },
        methods: {
            handleRequest(data) {
                console.log(data);
                return Promise.resolve();
            },
            handleRequestSuccess() {
                this.$message.success("发送成功");
            },
            changePieceWeight: function (value) {
                if (!value || !app.formData.pieceNum) {
                    app.formData.total = 0;
                } else {
                    app.formData.total = app.formData.pieceNum * value;
                }
            }
        }
    });

    function loadProvider(data) {
        return new Promise((resolve, reject) => {
            axios.post('/convert/list.action', data)
                .then((res) => {
                    resolve(res.data);
                    // console.log(res);
                })
                .catch(function (error) {
                    reject(error);
                    // console.log(error);
                });
        });
    }
</script>
</#bs4Body>
